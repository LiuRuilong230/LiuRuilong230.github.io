<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>不重复序号抽取系统</title>
  <!-- 引入外部资源 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- Tailwind配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#2563EB',
            secondary: '#059669',
            accent: '#D97706',
            danger: '#DC2626',
            dark: '#1E293B',
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .card-hover {
        @apply transition-all duration-300 hover:shadow-lg hover:-translate-y-1;
      }
      .btn-effect {
        @apply transition-all duration-200 active:scale-95;
      }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans text-gray-800">
  <!-- 导航栏 -->
  <nav class="bg-white shadow-md fixed w-full z-50 transition-all duration-300" id="navbar">
    <div class="container mx-auto px-4 py-3 flex flex-wrap justify-between items-center">
      <div class="flex items-center space-x-2">
        <i class="fa fa-sort-numeric-asc text-primary text-2xl"></i>
        <h1 class="text-xl font-bold text-dark">序号抽取系统</h1>
      </div>
      <div class="flex flex-wrap gap-2 mt-2 sm:mt-0">
        <button id="show-form-btn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 btn-effect flex items-center">
          <i class="fa fa-user-plus mr-2"></i>添加人员
        </button>
        <button id="show-records-btn" class="px-4 py-2 bg-secondary text-white rounded-lg hover:bg-secondary/90 btn-effect flex items-center">
          <i class="fa fa-list mr-2"></i>查看记录
        </button>
      </div>
    </div>
  </nav>

  <!-- 主内容区 -->
  <main class="container mx-auto px-4 pt-24 pb-16">
    <!-- 欢迎信息 -->
    <div class="text-center mb-12">
      <h2 class="text-[clamp(1.8rem,4vw,2.5rem)] font-bold text-dark mb-4">有序不重复的序号抽取</h2>
      <p class="text-gray-600 max-w-2xl mx-auto text-lg">系统将为每位参与者分配唯一序号，直到达到设定上限</p>
    </div>

    <!-- 状态指示器 -->
    <div class="max-w-4xl mx-auto bg-white rounded-xl p-4 shadow-sm mb-8 flex flex-wrap justify-between items-center">
      <div class="flex items-center mb-2 sm:mb-0">
        <div class="w-3 h-3 rounded-full bg-primary mr-2"></div>
        <span id="status-info">当前状态：可添加新人员</span>
      </div>
      <div class="flex space-x-4">
        <div class="text-sm">
          <span class="text-gray-500">已分配：</span>
          <span id="assigned-count" class="font-semibold">0</span>
        </div>
        <div class="text-sm">
          <span class="text-gray-500">上限：</span>
          <span id="max-count" class="font-semibold">60</span>
        </div>
      </div>
    </div>

    <!-- 表单卡片 -->
    <div id="form-card" class="max-w-md mx-auto bg-white rounded-xl p-6 md:p-8 shadow-md card-hover">
      <h3 class="text-xl font-bold text-center mb-6 text-dark">输入参与者信息</h3>
      
      <form id="participant-form" class="space-y-5">
        <div>
          <label for="name" class="block text-sm font-medium text-gray-700 mb-1">姓名</label>
          <input 
            type="text" 
            id="name" 
            required
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all outline-none"
            placeholder="请输入姓名"
          >
        </div>
        
        <div>
          <label for="max-number" class="block text-sm font-medium text-gray-700 mb-1">序号上限</label>
          <input 
            type="number" 
            id="max-number" 
            required
            min="1"
            value="60"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all outline-none"
            placeholder="设置最大序号值"
          >
          <p class="text-xs text-gray-500 mt-1">注意：修改上限会重置当前序号池</p>
        </div>
        
        <button 
          type="submit" 
          id="draw-btn"
          class="w-full bg-accent hover:bg-accent/90 text-white font-medium py-3 px-4 rounded-lg btn-effect flex items-center justify-center"
        >
          <i class="fa fa-random mr-2"></i>抽取序号
        </button>
      </form>
    </div>

    <!-- 结果显示区域 -->
    <div id="result-card" class="max-w-md mx-auto bg-white rounded-xl p-6 md:p-8 shadow-md mt-8 hidden card-hover">
      <div class="text-center">
        <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fa fa-check text-primary text-2xl"></i>
        </div>
        <h3 class="text-xl font-bold text-dark mb-2">抽取成功！</h3>
        <p class="text-gray-600 mb-6">已为参与者分配唯一序号</p>
        
        <div class="bg-gray-50 rounded-lg p-5 mb-6">
          <p class="text-gray-600 mb-2">姓名: <span id="result-name" class="font-semibold text-dark"></span></p>
          <p class="text-gray-600">分配序号: <span id="result-number" class="font-bold text-2xl text-primary"></span></p>
        </div>
        
        <button id="new-participant-btn" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 btn-effect">
          继续添加
        </button>
      </div>
    </div>

    <!-- 记录列表 -->
    <div id="records-section" class="max-w-4xl mx-auto mt-8 hidden">
      <div class="flex flex-wrap justify-between items-center mb-6 gap-3">
        <h3 class="text-2xl font-bold text-dark">抽取记录</h3>
        <div class="flex space-x-3">
          <button id="export-records-btn" class="px-4 py-2 bg-accent text-white rounded-lg hover:bg-accent/90 btn-effect flex items-center">
            <i class="fa fa-download mr-2"></i>导出记录
          </button>
          <button id="clear-records-btn" class="px-4 py-2 bg-danger text-white rounded-lg hover:bg-danger/90 btn-effect flex items-center">
            <i class="fa fa-trash mr-2"></i>清空记录
          </button>
        </div>
      </div>
      
      <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">序号</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">姓名</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">分配序号</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">时间</th>
              </tr>
            </thead>
            <tbody id="records-table-body" class="bg-white divide-y divide-gray-200">
              <!-- 记录将通过JavaScript动态添加 -->
            </tbody>
          </table>
        </div>
        
        <div id="no-records-message" class="p-8 text-center text-gray-500">
          <i class="fa fa-folder-open-o text-4xl mb-4"></i>
          <p>暂无记录，请添加人员生成记录</p>
        </div>
      </div>
    </div>
  </main>

  <!-- 页脚 -->
  <footer class="bg-dark text-white py-6 mt-auto">
    <div class="container mx-auto px-4 text-center">
      <p>&copy; 2023 序号抽取系统 | 不重复分配，公平公正</p>
    </div>
  </footer>

  <!-- 通知提示组件 -->
  <div id="toast" class="fixed bottom-5 right-5 bg-dark text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center z-50">
    <i id="toast-icon" class="mr-2"></i>
    <span id="toast-message"></span>
  </div>

  <script>
    // DOM元素
    const formCard = document.getElementById('form-card');
    const resultCard = document.getElementById('result-card');
    const recordsSection = document.getElementById('records-section');
    const participantForm = document.getElementById('participant-form');
    const nameInput = document.getElementById('name');
    const maxNumberInput = document.getElementById('max-number');
    const resultName = document.getElementById('result-name');
    const resultNumber = document.getElementById('result-number');
    const showFormBtn = document.getElementById('show-form-btn');
    const showRecordsBtn = document.getElementById('show-records-btn');
    const newParticipantBtn = document.getElementById('new-participant-btn');
    const recordsTableBody = document.getElementById('records-table-body');
    const noRecordsMessage = document.getElementById('no-records-message');
    const clearRecordsBtn = document.getElementById('clear-records-btn');
    const exportRecordsBtn = document.getElementById('export-records-btn');
    const navbar = document.getElementById('navbar');
    const toast = document.getElementById('toast');
    const toastIcon = document.getElementById('toast-icon');
    const toastMessage = document.getElementById('toast-message');
    const assignedCountEl = document.getElementById('assigned-count');
    const maxCountEl = document.getElementById('max-count');
    const statusInfoEl = document.getElementById('status-info');
    const drawBtn = document.getElementById('draw-btn');

    // 应用状态
    let records = JSON.parse(localStorage.getItem('drawRecords')) || [];
    let availableNumbers = [];
    let currentMaxNumber = parseInt(localStorage.getItem('currentMaxNumber')) || 60;

    // 初始化可用号码池
    function initAvailableNumbers(max) {
      availableNumbers = [];
      for (let i = 1; i <= max; i++) {
        // 检查号码是否已被使用
        const isUsed = records.some(record => record.number === i);
        if (!isUsed) {
          availableNumbers.push(i);
        }
      }
      currentMaxNumber = max;
      localStorage.setItem('currentMaxNumber', max.toString());
      updateStatus();
    }

    // 更新状态显示
    function updateStatus() {
      assignedCountEl.textContent = records.length;
      maxCountEl.textContent = currentMaxNumber;
      
      if (availableNumbers.length === 0) {
        statusInfoEl.textContent = '当前状态：已达最大上限，无法继续分配';
        statusInfoEl.classList.add('text-danger');
        drawBtn.disabled = true;
        drawBtn.classList.add('opacity-70', 'cursor-not-allowed');
      } else {
        statusInfoEl.textContent = '当前状态：可添加新人员';
        statusInfoEl.classList.remove('text-danger');
        drawBtn.disabled = false;
        drawBtn.classList.remove('opacity-70', 'cursor-not-allowed');
      }
    }

    // 显示通知
    function showToast(message, isSuccess = true) {
      toastMessage.textContent = message;
      toastIcon.className = isSuccess ? 'fa fa-check-circle mr-2' : 'fa fa-exclamation-circle mr-2';
      toast.classList.remove('translate-y-20', 'opacity-0');
      toast.classList.add('translate-y-0', 'opacity-100');
      
      setTimeout(() => {
        toast.classList.remove('translate-y-0', 'opacity-100');
        toast.classList.add('translate-y-20', 'opacity-0');
      }, 3000);
    }

    // 从可用号码中随机选择一个并移除
    function getUniqueRandomNumber() {
      if (availableNumbers.length === 0) return null;
      
      const randomIndex = Math.floor(Math.random() * availableNumbers.length);
      const selectedNumber = availableNumbers[randomIndex];
      
      // 从可用池移除已选号码
      availableNumbers.splice(randomIndex, 1);
      
      return selectedNumber;
    }

    // 保存记录到本地存储
    function saveRecord(name, number) {
      const now = new Date();
      const formattedTime = now.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      
      const record = {
        id: Date.now(),
        name,
        number,
        time: formattedTime
      };
      
      records.push(record);
      localStorage.setItem('drawRecords', JSON.stringify(records));
      
      return record;
    }

    // 渲染记录列表
    function renderRecords() {
      recordsTableBody.innerHTML = '';
      
      if (records.length === 0) {
        noRecordsMessage.classList.remove('hidden');
        return;
      }
      
      noRecordsMessage.classList.add('hidden');
      
      // 按号码排序
      const sortedRecords = [...records].sort((a, b) => a.number - b.number);
      
      sortedRecords.forEach((record, index) => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 transition-all';
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">${index + 1}</td>
          <td class="px-6 py-4 whitespace-nowrap">${record.name}</td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-primary/10 text-primary">
              ${record.number}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.time}</td>
        `;
        recordsTableBody.appendChild(row);
      });
    }

    // 导出记录为CSV
    function exportRecordsToCSV() {
      if (records.length === 0) {
        showToast('没有记录可导出', false);
        return;
      }
      
      // 按号码排序
      const sortedRecords = [...records].sort((a, b) => a.number - b.number);
      
      // 构建CSV内容
      let csvContent = "序号,姓名,分配序号,时间\n";
      
      sortedRecords.forEach((record, index) => {
        csvContent += `${index + 1},${record.name},${record.number},${record.time}\n`;
      });
      
      // 创建下载链接
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      
      // 文件名包含当前日期
      const today = new Date().toLocaleDateString().replace(/\//g, '-');
      link.setAttribute('download', `序号分配记录_${today}.csv`);
      
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showToast('记录已成功导出');
    }

    // 显示表单，隐藏结果和记录
    function showForm() {
      formCard.classList.remove('hidden');
      resultCard.classList.add('hidden');
      recordsSection.classList.add('hidden');
      
      // 滚动到表单
      formCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // 显示结果，隐藏表单和记录
    function showResult() {
      formCard.classList.add('hidden');
      resultCard.classList.remove('hidden');
      recordsSection.classList.add('hidden');
      
      // 滚动到结果
      resultCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // 显示记录，隐藏表单和结果
    function showRecords() {
      formCard.classList.add('hidden');
      resultCard.classList.add('hidden');
      recordsSection.classList.remove('hidden');
      
      renderRecords();
      
      // 滚动到记录
      recordsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // 表单提交处理
    participantForm.addEventListener('submit', (e) => {
      e.preventDefault();
      
      const name = nameInput.value.trim();
      const maxNumber = parseInt(maxNumberInput.value);
      
      if (!name) {
        showToast('请输入姓名', false);
        return;
      }
      
      if (isNaN(maxNumber) || maxNumber < 1) {
        showToast('请输入有效的最大数值', false);
        return;
      }
      
      // 如果修改了最大数值，重新初始化号码池
      if (maxNumber !== currentMaxNumber) {
        initAvailableNumbers(maxNumber);
      }
      
      // 检查是否还有可用号码
      if (availableNumbers.length === 0) {
        showToast('已达最大上限，无法继续分配', false);
        return;
      }
      
      // 检查姓名是否已存在
      const nameExists = records.some(record => record.name.trim() === name);
      if (nameExists) {
        if (!confirm('该姓名已存在，是否继续分配新序号？')) {
          return;
        }
      }
      
      const uniqueNumber = getUniqueRandomNumber();
      if (uniqueNumber === null) {
        showToast('无法生成序号，请检查设置', false);
        return;
      }
      
      saveRecord(name, uniqueNumber);
      
      resultName.textContent = name;
      resultNumber.textContent = uniqueNumber;
      
      updateStatus();
      showResult();
      showToast('已成功分配唯一序号');
      
      // 重置表单
      nameInput.value = '';
    });

    // 最大数值变化时的处理
    maxNumberInput.addEventListener('change', (e) => {
      const newMax = parseInt(e.target.value);
      if (!isNaN(newMax) && newMax > 0 && newMax !== currentMaxNumber) {
        if (records.length > 0) {
          if (confirm('修改最大序号会重置当前序号池，是否继续？')) {
            initAvailableNumbers(newMax);
          } else {
            e.target.value = currentMaxNumber;
          }
        } else {
          initAvailableNumbers(newMax);
        }
      }
    });

    // 按钮事件监听
    showFormBtn.addEventListener('click', showForm);
    showRecordsBtn.addEventListener('click', showRecords);
    newParticipantBtn.addEventListener('click', showForm);
    exportRecordsBtn.addEventListener('click', exportRecordsToCSV);

    // 清空记录
    clearRecordsBtn.addEventListener('click', () => {
      if (records.length === 0) {
        showToast('没有记录可清空', false);
        return;
      }
      
      if (confirm('确定要清空所有记录吗？此操作不可恢复。')) {
        records = [];
        localStorage.removeItem('drawRecords');
        initAvailableNumbers(currentMaxNumber);
        renderRecords();
        showToast('所有记录已清空');
      }
    });

    // 滚动时导航栏效果
    window.addEventListener('scroll', () => {
      if (window.scrollY > 10) {
        navbar.classList.add('py-2', 'shadow-lg');
        navbar.classList.remove('py-3', 'shadow-md');
      } else {
        navbar.classList.add('py-3', 'shadow-md');
        navbar.classList.remove('py-2', 'shadow-lg');
      }
    });

    // 初始化页面
    function init() {
      maxNumberInput.value = currentMaxNumber;
      initAvailableNumbers(currentMaxNumber);
      showForm();
    }

    // 启动应用
    init();
  </script>
</body>
</html>